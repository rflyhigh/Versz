<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Versz - Share Your Lyrics</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cabinet-grotesk/1.0.0/cabinet-grotesk.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        body {
            font-family: 'Cabinet Grotesk', sans-serif;
            background: #121212;
            color: #fff;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .auth-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 60px 20px;
            gap: 40px;
        }

        .hero {
            text-align: center;
            max-width: 600px;
        }

        .hero h1 {
            font-size: 48px;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #2196F3, #4ECDC4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hero p {
            font-size: 20px;
            opacity: 0.8;
            line-height: 1.6;
        }

        .auth-forms {
            display: flex;
            gap: 40px;
            width: 100%;
            max-width: 800px;
        }

        .auth-form {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 16px;
            backdrop-filter: blur(10px);
        }

        .auth-form h2 {
            margin-bottom: 24px;
            font-size: 24px;
        }

        .input {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .input:focus {
            border-color: #2196F3;
            outline: none;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #1976D2;
        }

        .dashboard {
            padding: 40px 20px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .dashboard-header h1 {
            font-size: 32px;
        }

        .lyrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .lyrics-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .lyrics-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.08);
        }

        .lyrics-card h3 {
            margin-bottom: 8px;
            font-size: 20px;
        }

        .lyrics-card p {
            opacity: 0.7;
            font-size: 14px;
        }

        .editor {
            padding-top: 60px;
        }

        .toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 12px;
            display: flex;
            gap: 12px;
            justify-content: center;
            z-index: 1000;
        }

        .toolbar select,
        .toolbar button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toolbar select:hover,
        .toolbar button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .editor-content {
            max-width: 800px;
            margin: 0 auto;
        }

        .editor-header input {
            width: 100%;
            background: none;
            border: none;
            color: white;
            outline: none;
        }

        .editor-header .title {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .editor-header .subtitle {
            font-size: 18px;
            opacity: 0.7;
        }

        .lyrics-editor {
            margin-top: 40px;
            min-height: 500px;
            white-space: pre-wrap;
            line-height: 1.6;
            outline: none;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            backdrop-filter: blur(10px);
            z-index: 2000;
            transition: all 0.3s ease;
        }

        .notification.success {
            background: rgba(46, 213, 115, 0.8);
        }

        .notification.error {
            background: rgba(255, 71, 87, 0.8);
        }

        .notification.fade-out {
            opacity: 0;
            transform: translateY(20px);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-content {
            background: #1E1E1E;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
        }

        .modal h2 {
            margin-bottom: 20px;
        }

        .share-url {
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin: 20px 0;
            word-break: break-all;
        }

        @media (max-width: 768px) {
            .auth-forms {
                flex-direction: column;
            }

            .hero h1 {
                font-size: 36px;
            }

            .toolbar {
                flex-wrap: wrap;
            }

            .editor-header .title {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        const api = {
    baseURL: 'https://tiffintreats.onrender.com',

    async request(endpoint, options = {}) {
        const token = localStorage.getItem('token');
        
        const defaultHeaders = {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            ...(token && { 'Authorization': `Bearer ${token}` })
        };

        try {
            const response = await fetch(`${this.baseURL}${endpoint}`, {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...options.headers
                }
            });

            let responseData;
            const contentType = response.headers.get('content-type');
            
            try {
                responseData = await response.text();
                // Try to parse as JSON only if it looks like JSON
                if (contentType?.includes('application/json')) {
                    responseData = JSON.parse(responseData);
                } else {
                    console.error('Non-JSON response:', responseData);
                    throw new Error('Server returned non-JSON response');
                }
            } catch (parseError) {
                console.error('Response parsing error:', parseError);
                console.error('Raw response:', responseData);
                throw new Error('Failed to parse server response');
            }

            if (!response.ok) {
                throw new Error(responseData.detail || 'API request failed');
            }

            return responseData;
        } catch (error) {
            console.error('API Error:', error);
            throw error;
        }
    },

    async login(username, password) {
        try {
            const formData = new URLSearchParams();
            formData.append('username', username);
            formData.append('password', password);

            const response = await fetch(`${this.baseURL}/token`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Accept': 'application/json'
                },
                body: formData
            });

            const contentType = response.headers.get('content-type');
            const responseText = await response.text();

            let data;
            try {
                data = JSON.parse(responseText);
            } catch (parseError) {
                console.error('Login response:', responseText);
                console.error('Content-Type:', contentType);
                throw new Error('Invalid server response during login');
            }

            if (!response.ok) {
                throw new Error(data.detail || 'Login failed');
            }

            return data;
        } catch (error) {
            console.error('Login Error:', error);
            throw error;
        }
    },

    // Rest of the methods remain the same as before
    async register(username, name, password) {
        return this.request('/register', {
            method: 'POST',
            body: JSON.stringify({ username, name, password })
        });
    },

    async getLyrics() {
        return this.request('/lyrics');
    },

    async createLyrics(content) {
        return this.request('/lyrics', {
            method: 'POST',
            body: JSON.stringify(content)
        });
    },

    async updateLyrics(id, content) {
        return this.request(`/lyrics/${id}`, {
            method: 'PUT',
            body: JSON.stringify(content)
        });
    },

    async shareLyrics(extension, content) {
        return this.request('/share', {
            method: 'POST',
            body: JSON.stringify({ extension, content })
        });
    },

    async getSharedLyrics(extension) {
        return this.request(`/share/${extension}`);
    }
};
        // Router
        const router = {
            init() {
                this.handleRoute();
                window.addEventListener('popstate', () => this.handleRoute());
            },

            navigate(path) {
                history.pushState(null, null, path);
                this.handleRoute();
            },

            handleRoute() {
                const path = window.location.pathname;

                if (!localStorage.getItem('token') && path !== '/') {
                    this.navigate('/');
                    return;
                }

                if (path === '/') {
                    this.renderHome();
                } else if (path === '/dashboard') {
                    this.renderDashboard();
                } else if (path.startsWith('/editor')) {
                    const id = path.split('/')[2];
                    this.renderEditor(id);
                } else if (path.startsWith('/share/')) {
                    this.renderSharedLyrics(path.split('/')[2]);
                }
            },

            async renderHome() {
                if (localStorage.getItem('token')) {
                    this.navigate('/dashboard');
                    return;
                }

                document.getElementById('app').innerHTML = `
                    <div class="auth-container">
                        <div class="hero">
                            <h1>Welcome to Versz</h1>
                            <p>Create beautiful lyrics, style them your way, and share them with the world.</p>
                        </div>
                        <div class="auth-forms">
                            <div class="auth-form">
                                <h2>Login</h2>
                                <form id="loginForm">
                                    <input type="text" class="input" placeholder="Username" required>
                                    <input type="password" class="input" placeholder="Password" required>
                                    <button type="submit" class="btn">Login</button>
                                </form>
                            </div>
                            <div class="auth-form">
                                <h2>Register</h2>
                                <form id="registerForm">
                                    <input type="text" class="input" placeholder="Username" required>
                                    <input type="text" class="input" placeholder="Name" required>
                                    <input type="password" class="input" placeholder="Password" required>
                                    <button type="submit" class="btn">Register</button>
                                </form>
                            </div>
                        </div>
                    </div>
                `;

                this.setupAuthListeners();
            },

            async renderDashboard() {
                document.getElementById('app').innerHTML = `
                    <div class="dashboard">
                        <div class="dashboard-header">
                            <h1>Your Lyrics</h1>
                            <div>
                                <button class="btn" onclick="router.navigate('/editor')">Create New</button>
                                <button class="btn" onclick="logout()">Logout</button>
                            </div>
                        </div>
                        <div class="lyrics-grid" id="lyricsGrid">Loading...</div>
                    </div>
                `;

                try {
                    const lyrics = await api.getLyrics();
                    const grid = document.getElementById('lyricsGrid');
                    
                    if (!lyrics || lyrics.length === 0) {
                        grid.innerHTML = '<p style="text-align: center; opacity: 0.7;">No lyrics yet. Create your first one!</p>';
                        return;
                    }

                    grid.innerHTML = lyrics
                        .sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at))
                        .map(lyric => `
                            <div class="lyrics-card" onclick="router.navigate('/editor/${lyric._id}')">
                                <h3>${lyric.content?.title || 'Untitled'}</h3>
                                <p>${lyric.content?.subtitle || 'No artist'}</p>
                                <div style="margin-top: 12px; opacity: 0.5; font-size: 12px;">
                                    Last updated: ${new Date(lyric.updated_at).toLocaleDateString()}
                                </div>
                            </div>
                        `).join('');
                } catch (error) {
                    showNotification('Failed to load lyrics', 'error');
                }
            },

            async renderEditor(id = null) {
                document.getElementById('app').innerHTML = `
                    <div class="editor">
                        <div class="toolbar">
                            <button onclick="router.navigate('/dashboard')">← Back</button>
                            <select id="fontSize">
                                <option value="14">14px</option>
                                <option value="16">16px</option>
                                <option value="18" selected>18px</option>
                                <option value="20">20px</option>
                                <option value="24">24px</option>
                            </select>
                            <select id="textColor">
                                <option value="inherit">Default</option>
                                <option value="#FF6B6B">Red</option>
                                <option value="#4ECDC4">Cyan</option>
                                <option value="#FFE66D">Yellow</option>
                                <option value="#95E1D3">Mint</option>
                            </select>
                            <select id="textFormat">
                                <option value="none">Normal</option>
                                <option value="uppercase">Uppercase</option>
                                <option value="lowercase">Lowercase</option>
                                <option value="capitalize">Capitalize</option>
                            </select>
                            <button onclick="saveLyrics()">Save</button>
                            <button onclick="shareLyrics()">Share</button>
                        </div>
                        <div class="editor-content">
                            <div class="editor-header">
                                <input type="text" class="title" id="title" placeholder="Enter title">
                                <input type="text" class="subtitle" id="subtitle" placeholder="Enter artist name">
                            </div>
                            <div class="lyrics-editor" id="lyrics" contenteditable="true" 
                                 placeholder="Enter your lyrics here..."></div>
                        </div>
                    </div>
                `;

                this.setupEditor(id);
            },

            async setupEditor(id) {
                const editor = {
                    title: document.getElementById('title'),
                    subtitle: document.getElementById('subtitle'),
                    lyrics: document.getElementById('lyrics'),
                    fontSize: document.getElementById('fontSize'),
                    textColor: document.getElementById('textColor'),
                    textFormat: document.getElementById('textFormat'),
                    currentId: id,

                    init() {
                        this.setupAutosave();
                        this.applyStyles();
                        if (id) {
                            this.loadLyrics();
                        }
                    },

                    setupAutosave() {
                        let timeout;
                        const elements = [this.title, this.subtitle, this.lyrics];
                        elements.forEach(el => {
                            el.addEventListener('input', () => {
                                clearTimeout(timeout);
                                timeout = setTimeout(() => this.save(), 1000);
                            });
                        });

                        [this.fontSize, this.textColor, this.textFormat].forEach(el => {
                            el.addEventListener('change', () => {
                                this.applyStyles();
                                this.save();
                            });
                        });
                    },

                    applyStyles() {
                        this.lyrics.style.fontSize = `${this.fontSize.value}px`;
                        this.lyrics.style.color = this.textColor.value;
                        this.lyrics.style.textTransform = this.textFormat.value === 'none' ? 'none' : this.textFormat.value;
                    },

                    async loadLyrics() {
                        try {
                            const lyrics = await api.getLyrics();
                            const current = lyrics.find(l => l._id === this.currentId);
                            if (current) {
                                this.title.value = current.content.title || '';
                                this.subtitle.value = current.content.subtitle || '';
                                this.lyrics.innerHTML = current.content.lyrics || '';
                                this.fontSize.value = current.content.fontSize || '18';
                                this.textColor.value = current.content.textColor || 'inherit';
                                this.textFormat.value = current.content.textFormat || 'none';
                                this.applyStyles();
                            }
                        } catch (error) {
                            showNotification('Failed to load lyrics', 'error');
                        }
                    },

                    async save() {
                        const content = {
                            title: this.title.value || '',
                            subtitle: this.subtitle.value || '',
                            lyrics: this.lyrics.innerHTML || '',
                            fontSize: this.fontSize.value || '18',
                            textColor: this.textColor.value || 'inherit',
                            textFormat: this.textFormat.value || 'none',
                            theme: 'default' // Adding the missing required field
                        };
                    
                        try {
                            if (this.currentId) {
                                await api.updateLyrics(this.currentId, content);
                            } else {
                                const result = await api.createLyrics(content);
                                this.currentId = result.id;
                                history.replaceState(null, null, `/editor/${result.id}`);
                            }
                            showNotification('Saved successfully', 'success');
                        } catch (error) {
                            console.error('Save error:', error);
                            showNotification('Failed to save: ' + (error.message || 'Unknown error'), 'error');
                        }
                    }

                window.editor = editor;
                editor.init();
            },

            async renderSharedLyrics(extension) {
                try {
                    const lyrics = await api.getSharedLyrics(extension);
                    document.getElementById('app').innerHTML = `
                        <div class="editor">
                            <div class="toolbar">
                                <button onclick="window.location.href='/'">Home</button>
                            </div>
                            <div class="editor-content">
                                <div class="editor-header">
                                    <h1 class="title">${lyrics.title || 'Untitled'}</h1>
                                    <p class="subtitle">${lyrics.subtitle || 'No artist'}</p>
                                </div>
                                <div class="lyrics-editor" style="
                                    font-size: ${lyrics.fontSize}px;
                                    color: ${lyrics.textColor};
                                    text-transform: ${lyrics.textFormat};
                                ">${lyrics.lyrics}</div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    showNotification('Failed to load shared lyrics', 'error');
                }
            },

            setupAuthListeners() {
                document.getElementById('loginForm').addEventListener('submit', async (e) => {
                  e.preventDefault();
                        const formData = new FormData(e.target);
                        const username = formData.get('username');
                        const password = formData.get('password');

                        try {
                            const data = await api.login(username, password);
                            if (data.access_token) {
                                localStorage.setItem('token', data.access_token);
                                router.navigate('/dashboard');
                            } else {
                                showNotification('Login failed', 'error');
                            }
                        } catch (error) {
                            showNotification(error.message || 'Login failed', 'error');
                        }
                    });

                document.getElementById('registerForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const [username, name, password] = e.target.elements;
                    try {
                        await api.register(username.value, name.value, password.value);
                        const loginData = await api.login(username.value, password.value);
                        localStorage.setItem('token', loginData.access_token);
                        this.navigate('/dashboard');
                    } catch (error) {
                        showNotification('Registration failed', 'error');
                    }
                });
            }
        };

        // Utility functions
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        async function saveLyrics() {
            await window.editor.save();
        }

        async function shareLyrics() {
            try {
                const extension = Math.random().toString(36).substring(2, 8);
                const content = {
                    title: editor.title.value,
                    subtitle: editor.subtitle.value,
                    lyrics: editor.lyrics.innerHTML,
                    fontSize: editor.fontSize.value,
                    textColor: editor.textColor.value,
                    textFormat: editor.textFormat.value
                };

                const result = await api.shareLyrics(extension, content);
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <h2>Share Your Lyrics</h2>
                        <p>Share this link with others:</p>
                        <div class="share-url">${result.url}</div>
                        <button class="btn" onclick="navigator.clipboard.writeText('${result.url}')">
                            Copy Link
                        </button>
                        <button class="btn" onclick="this.closest('.modal').remove()">
                            Close
                        </button>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                showNotification('Failed to share lyrics', 'error');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            router.navigate('/');
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            router.init();
        });

        const loginFormHTML = `
        <form id="loginForm">
            <input type="text" name="username" class="input" placeholder="Username" required>
            <input type="password" name="password" class="input" placeholder="Password" required>
            <button type="submit" class="btn">Login</button>
        </form>
        `;
    </script>
</body>
</html>
